<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>{{ device[1] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .hidden {
            display: none;
        }

        .loader {
            border-top-color: transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar {
            display: none;
        }

        @media (min-width: 1024px) {
            .sidebar {
                display: block;
            }
        }

        .transform {
            transform: translateX(-100%);
        }

        .transform-active {
            transform: translateX(0);
        }

        .transition-transform {
            transition: transform 0.3s ease-in-out;
        }

        .hover-effect:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .card-border {
            border: 2px solid white;
            border-radius: 0.5rem;
        }

        .active-tab {
            background-color: #3b82f6 !important;
        }

        .inactive-tab {
            background-color: #4b5563 !important;
        }
    </style>


<link href="https://cdn.jsdelivr.net/npm/hopscotch@0.3.1/dist/css/hopscotch.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hopscotch@0.3.1/dist/js/hopscotch.min.js"></script>
<style>
    .hopscotch-bubble-container {
        max-width: 250px; /* Adjust the width to fit within your layout */
        overflow: hidden;
    }
    
    .hopscotch-bubble-arrow {
        display: none; /* Optionally, hide the arrow if it's causing layout issues */
    }
</style>

</head>

<body class="bg-gray-900 min-h-screen flex flex-col ">

    <!-- Navigation Bar -->
    <nav class="bg-gradient-to-r from-purple-800 to-indigo-900 shadow-lg p-4 flex justify-between items-center relative">
        <div class="text-lg font-semibold text-white">IoT-InQube Dashboard</div>
        <div class="flex space-x-2 items-center">
            <div class="relative">
                <button id="menu-btn" class="bg-gray-800 text-white px-4 py-2 rounded-lg">Menu</button>
                <div id="desktop-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 text-white shadow-lg">
                    <ul>
                        
                        <li class="mb-4 p-2 hover:bg-gray-700">
                            <a href="/dashboard" class="text-gray-400 hover:text-indigo-500">Devices</a>
                        </li>
                        <li class="mb-4 p-2 hover:bg-gray-700">
                            <a href="/profile_settings" class="text-gray-400 hover:text-indigo-500">Settings</a>
                        </li>
                    </ul>
                </div>
            </div>
            <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
        </div>
    </nav>

    <!-- Sidebar for Mobile -->
    <aside id="mobile-sidebar" class="bg-gray-800 w-64 p-4 shadow-lg fixed inset-y-0 left-0 transform transition-transform lg:hidden -translate-x-full">
        <div class="flex justify-end mb-4">
            <button id="close-sidebar-btn" class="bg-gray-800 text-white px-2 py-1">X</button>
        </div>
        <nav>
            <ul>
                
                <li class="mb-4">
                    <a href="/dashboard" class="text-gray-400 hover:text-indigo-500">Devices</a>
                </li>
                <li class="mb-4">
                    <a href="/profile_settings" class="text-gray-400 hover:text-indigo-500">Settings</a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Sidebar for Desktop -->
    <aside id="desktop-sidebar" class="bg-gray-800 w-64 p-4 shadow-lg hidden lg:block">
        <nav>
            <ul>
                
                <li class="mb-4">
                    <a href="/dashboard" class="text-gray-400 hover:text-indigo-500">Devices</a>
                </li>
                <li class="mb-4">
                    <a href="/profile_settings" class="text-gray-400 hover:text-indigo-500">Settings</a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex flex-grow">
        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h1 id="device-name" class="text-3xl font-semibold text-gray-200 mb-4">{{ device[1] }}</h1>
                        <p id="device-details" class="text-gray-400 mb-8">{{ device[0] }}<br>{{ device[2] }}<br>{{ device[3] }}</p>
                    </div>
                    <button id="add-data-btn" class="bg-green-500 text-white px-4 py-2 rounded flex items-center mb-4 md:mb-0">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Create New Data Chart
                    </button>
                </div>
            </div>

            <br>

            <div class="bg-gray-800 p-6 rounded-lg shadow-lg" id="chart_device_feed_section">

                <div class="col-span-12 md:col-span-8 bg-gray-800 p-6 rounded-lg shadow-lg text-white">
                        
                    <div id="chart_response"></div>
                
                </div>
            </div>

            <!-- Main Container for Device Data Points and Additional Blocks --><br>
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                <!-- Device Data Points Card (Width 8) -->
                <div class="col-span-12 md:col-span-8 bg-gray-800 p-6 rounded-lg shadow-lg text-white">
                    <h2 class="text-2xl font-semibold mb-4">Device Data Points</h2>
                    <div id="device-data-points" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {% for key, value in data_points.items() %}
                        <div class="bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border">
                            <h3 class="text-lg font-semibold">{{ key }}</h3>
                            <p class="text-2xl">{{ value }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                </div>

                

                <!-- Additional Block (Width 4) -->
                <div class="col-span-12 md:col-span-4 space-y-6">
                    <!-- Device Webhook Block -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-white">
                        <h2 class="text-2xl font-semibold mb-4">Device Webhook</h2>
                        <p id="device-webhook-url" class="break-words mb-4">
                            http://iot.mygreenqube.com:5000/data?device_id=26041990&temperature=25&humidity=60&pressure=1013
                        </p>
                        <button id="send-demo-data-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            Send Demo Device Data
                        </button>
                    </div>
                    
                    
                    
                    

                    <!-- Tabs Block -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg ">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Device Management</h2>
                        <div class="flex flex-col space-y-4">
                            <!-- Tabs Navigation -->
                            <nav class="flex space-x-4 mb-4" aria-label="Device Management Tabs">
                                <button id="alerts-tab" class="bg-blue-500 text-white px-4 py-2 rounded active-tab text-white">Alerts</button>

                                <button id="notifications-tab" class="bg-gray-700 text-white px-4 py-2 rounded inactive-tab relative">
                                    Notifications
                                    <span id="notification-counter" class="absolute top-0 right-0 bg-red-600 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center hidden">0</span>
                                </button>

                            </nav>

                            <!-- Alerts Content -->
                             <!-- Alerts Content -->
                             <div id="alerts-content">
                                <h3 class="text-xl font-semibold mb-2 text-white">Create Alert</h3>
                                <form id="alert-form">
                                    <div class="mb-4">
                                        <label for="alert-name" class="block text-gray-400">Alert Name</label>
                                        <input type="text" id="alert-name" class="w-full px-3 py-2 border rounded-lg" required>
                                    </div>
                                    <div class="mb-4">
                                        <label for="alert-parameter" class="block text-gray-400">Parameter</label>
                                        <select id="alert-parameter" class="w-full px-3 py-2 border rounded-lg" required>
                                            <!-- Options will be dynamically added -->
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label for="alert-gate" class="block text-gray-400">Alert Logic</label>
                                        <select id="alert-gate" name="alert_gate" class="w-full px-3 py-2 border rounded-lg" required>
                                            <!-- Options will be dynamically added -->
                                             <option value="Greater Than">Greater Than</option>
                                             <option value="Less Than">Less Than</option>
                                             <option value="Equal To">Equal to</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label for="alert-value" class="block text-gray-400">Value</label>
                                        <input type="number" id="alert-value" class="w-full px-3 py-2 border rounded-lg" required>
                                    </div>
                                    <button type="button" onClick="CreateAlert();" class="bg-blue-500 text-white px-4 py-2 rounded">Create Alert</button>
                                </form>
                                <h3 class="text-xl font-semibold mt-4 text-white">Alert List</h3>
                                <ul id="alert-list" class="space-y-2">
                                    <!-- Alerts will be dynamically added here -->
                                </ul>
                            </div>

                            <!-- Notifications Content -->
                            <div id="notifications-content" class="hidden">
                                <h3 class="text-xl font-semibold mb-2 text-white">Notifications</h3>
                                <ul id="notifications-list" class="space-y-2 text-white">
                                    <li class="bg-gray-700 p-2 rounded">Sample Notification 1</li>
                                    <li class="bg-gray-700 p-2 rounded">Sample Notification 2</li>
                                    <li class="bg-gray-700 p-2 rounded">Sample Notification 3</li>
                                </ul>
                            </div>

                            <!-- All Device Data Content -->
                            <div id="all-data-content" class="hidden">
                                <h3 class="text-xl font-semibold mb-2 text-white">All Device Records</h3>
                                <div class="overflow-auto max-h-96">
                                    <table class="min-w-full text-white">
                                        <thead>
                                            <tr class="bg-gray-700">
                                                <th class="px-4 py-2">Time</th>
                                                <th class="px-4 py-2">Parameters</th>
                                            </tr>
                                        </thead>
                                        <tbody id="all-data-list" class="bg-gray-600">
                                            <!-- Data will be dynamically added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                       
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Charts Card -->
            <div class="bg-gray-800 p-6 mt-6 rounded-lg shadow-lg text-white">
                <h2 class="text-2xl font-semibold mb-4">Device Charts</h2>
                <div id="device-charts" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Chart cards will be dynamically added here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Loader Modal -->
    <div id="loader-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="flex flex-col items-center">
            <div class="loader border-4 border-blue-500"></div>
            <p class="text-white mt-4">Please Wait...</p>
        </div>
    </div>

    <!-- Add Data Chart Modal -->
<div id="add-data-chart-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg mx-4">
        <h2 class="text-xl font-semibold mb-4" style="color: black;">Create New Data Chart</h2>
        <form id="add-data-chart-form">
            <div class="mb-4">
                <label for="chart-name" class="block text-gray-700">Chart Name</label>
                <input type="text" id="chart-name" name="chartName" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label for="chart-type" class="block text-gray-700">Chart Type</label>
                <select id="chart-type" name="chartType" class="w-full px-3 py-2 border rounded-lg" required>
                    <option value="line">Line</option>
                    <option value="bar">Bar</option>
                    <option value="radar">Radar</option>
                    <option value="pie">Pie</option>
                    <option value="doughnut">Doughnut</option>
                </select>
            </div>

            <div class="mb-4">
                <input type="checkbox" id="live-data" name="liveData">
                <label for="live-data" class="text-gray-700">Get Live Data</label>
            </div>

            <div id="date-range-fields" class="mb-4">
                <div class="mb-4">
                    <label for="start-date" class="block text-gray-700">Start Date</label>
                    <input type="date" id="start-date" name="startDate" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="end-date" class="block text-gray-700">End Date</label>
                    <input type="date" id="end-date" name="endDate" class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700">X-Axis Parameter</label>
                <div id="x-axis-params" class="grid grid-cols-1 gap-2">
                    <!-- Radio buttons will be dynamically added here -->
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700">Y-Axis Parameters</label>
                <div id="y-axis-params" class="grid grid-cols-2 gap-2">
                    <!-- Checkboxes will be dynamically added here -->
                </div>
            </div>

            <div class="flex justify-end">
                <button type="button" id="cancel-add-data-chart" class="bg-gray-500 text-white px-4 py-2 rounded-lg mr-2">Cancel</button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Create Chart</button>
            </div>
        </form>
    </div>
</div>

    

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md mx-4">
            <h2 class="text-xl font-semibold mb-4" style="color: black;">Delete Confirmation</h2>
            <p id="delete-confirmation-message" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button type="button" id="cancel-delete" class="bg-gray-500 text-white px-4 py-2 rounded-lg mr-2">Cancel</button>
                <button type="button" id="confirm-delete" class="bg-red-500 text-white px-4 py-2 rounded-lg">Delete</button>
            </div>
        </div>
    </div>


    <script>
        let selectedChartId = null;

function titleCase(str) {
    return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function showError(message) {
    alert(message);
}

function showDeleteConfirmation(chartId, chartName) {
    selectedChartId = chartId;
    const confirmationEl = document.getElementById('delete-confirmation-message');
    const modalEl = document.getElementById('delete-confirmation-modal');
    if (confirmationEl && modalEl) {
        confirmationEl.textContent = `Are you sure you want to delete the chart "${chartName}"?`;
        modalEl.classList.remove('hidden');
    }
}

function deleteChart(chartId) {
    fetch(`/delete-chart/${chartId}`, { method: 'POST' })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                const chartElement = document.querySelector(`[data-chart-id="${chartId}"]`);
                if (chartElement) chartElement.parentElement.remove();
            }
        })
        .catch(error => console.error('Delete chart failed:', error));
}

function getDeviceIdFromUrl() {
    const urlParts = window.location.pathname.split('/');
    return urlParts[urlParts.length - 1];
}

function fetchDeviceData(deviceId) {
    return fetch(`/device_data/${deviceId}`)
        .then(response => response.json())
        .then(data => {
            const nameEl = document.getElementById('device-name');
            const detailsEl = document.getElementById('device-details');
            if (nameEl) nameEl.textContent = data.device_name;
            if (detailsEl) {
                detailsEl.innerHTML = `${data.device_id}<br>${data.device_type}<br>${data.device_description}`;
            }
            updateDeviceDataPoints(data.data_points);
            populateYAxisParams(data.data_points, 'y-axis-params');
            populateXAxisParams(data.data_points, 'x-axis-params');
            updateDeviceWebhook(data.device_id, data.data_points);
            populateAlertParameters(data.data_points);
            return data;
        })
        .catch(error => {
            console.error('Error fetching device data:', error);
            return {};
        });
}


function populateParams(params) {
    const xAxisParamsContainer = document.getElementById('x-axis-params');
    const yAxisParamsContainer = document.getElementById('y-axis-params');
    if (!xAxisParamsContainer || !yAxisParamsContainer) return;

    xAxisParamsContainer.innerHTML = '';
    yAxisParamsContainer.innerHTML = '';

    params.forEach(param => {
        // X-axis radio button
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.id = `x-axis-param-${param}`;
        radio.name = 'xAxisParam';
        radio.value = param;
        radio.required = true;

        const radioLabel = document.createElement('label');
        radioLabel.htmlFor = radio.id;
        radioLabel.textContent = param;

        const radioDiv = document.createElement('div');
        radioDiv.appendChild(radio);
        radioDiv.appendChild(radioLabel);
        xAxisParamsContainer.appendChild(radioDiv);

        // Y-axis checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `y-axis-param-${param}`;
        checkbox.name = 'yAxisParams';
        checkbox.value = param;

        const checkboxLabel = document.createElement('label');
        checkboxLabel.htmlFor = checkbox.id;
        checkboxLabel.textContent = param;

        const checkboxDiv = document.createElement('div');
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(checkboxLabel);
        yAxisParamsContainer.appendChild(checkboxDiv);
    });
}

function updateDeviceWebhook(deviceId, dataPoints) {
    const webhookEl = document.getElementById('device-webhook-url');
    if (!webhookEl) return;

    const origin = window.location.origin;
    const payload = Object.entries(dataPoints && Object.keys(dataPoints).length ? dataPoints : {
        temperature: '25',
        humidity: '60',
        pressure: '1013'
    }).map(([key, value]) => `${key}=${value}`).join('&');

    webhookEl.textContent = `${origin}/data?device_id=${deviceId}&${payload}`;
}

function updateDeviceDataPoints(dataPoints) {
    const container = document.getElementById('device-data-points');
    if (!container) return;

    container.innerHTML = '';
    for (const [key, value] of Object.entries(dataPoints)) {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
        card.innerHTML = `<h3 class="text-lg font-semibold">${key}</h3><p class="text-2xl">${value}</p>`;
        container.appendChild(card);
    }
}


function populateYAxisParams(dataPoints, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    for (const key in dataPoints) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center';
        wrapper.innerHTML = `
            <input type="checkbox" id="${key}" name="yAxisParams" value="${key}" class="mr-2">
            <label for="${key}" class="text-gray-700">${key}</label>
        `;
        container.appendChild(wrapper);
    }
}

function populateXAxisParams(dataPoints, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    for (const key in dataPoints) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center';
        wrapper.innerHTML = `
            <input type="radio" id="x-axis-${key}" name="xAxisParam" value="${key}" class="mr-2">
            <label for="x-axis-${key}" class="text-gray-700">${key}</label>
        `;
        container.appendChild(wrapper);
    }

    const timestampWrapper = document.createElement('div');
    timestampWrapper.className = 'flex items-center';
    timestampWrapper.innerHTML = `
        <input type="radio" id="x-axis-timestamp" name="xAxisParam" value="time" class="mr-2">
        <label for="x-axis-timestamp" class="text-gray-700">timestamp</label>
    `;
    container.appendChild(timestampWrapper);
}

function populateAlertParameters(dataPoints) {
    const select = document.getElementById('alert-parameter');
    if (!select) return;
    select.innerHTML = '';

    for (const key in dataPoints) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
    }
}

function fetchAlerts(deviceId) {
    return fetch(`/get-alerts/${deviceId}`, {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    })
    .then(res => res.json())
    .then(data => {
        if (data.alerts) updateAlertList(data.alerts);
    })
    .catch(err => console.error('Error fetching alerts:', err));
}

function updateAlertList(alerts) {
    const container = document.getElementById('alert-list');
    if (!container) return;
    container.innerHTML = '';

    alerts.forEach(alert => {
        const li = document.createElement('li');
        li.className = 'bg-gray-700 p-2 rounded flex justify-between items-center text-white';
        li.innerHTML = `
            <span>${alert.name} - ${alert.parameter}: ${alert.value}</span>
            <button class="bg-red-500 text-white px-2 py-1 rounded delete-alert-btn" data-alert-id="${alert.id}">Delete</button>
        `;
        container.appendChild(li);

        li.querySelector('.delete-alert-btn').addEventListener('click', () => {
            deleteAlert(alert.id);
        });
    });
}


function CreateAlert() {
    const deviceId = getDeviceIdFromUrl();
    const alertName = document.getElementById('alert-name')?.value;
    const alertParameter = document.getElementById('alert-parameter')?.value;
    const alertValue = document.getElementById('alert-value')?.value;
    const alertGate = document.getElementById('alert-gate')?.value;

    fetch('/create_alert', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
            device_id: deviceId,
            alert_name: alertName,
            alert_parameter: alertParameter,
            alert_value: alertValue,
            alert_gate: alertGate
        })
    })
    .then(response => response.json())
    .then(() => fetchAlerts(deviceId))
    .catch(error => console.error('Error creating alert:', error));
}

function deleteAlert(alertId) {
    fetch(`/delete_alert/${alertId}`, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => response.json())
    .then(() => {
        const deviceId = getDeviceIdFromUrl();
        fetchAlerts(deviceId);
    })
    .catch(error => console.error('Error deleting alert:', error));
}

function fetchNotifications(device_id) {
    const token = localStorage.getItem('token');
    $.ajax({
        url: `/get-notifications/${device_id}`,
        type: 'GET',
        headers: { 'Authorization': `Bearer ${token}` },
        success: function (data) {
            populateNotificationsList(data.notifications);
            updateNotificationCounter(data.unseen_count);
        },
        error: function (jqXHR, textStatus, errorThrown) {
            console.log('AJAX call failed');
            console.error('Error:', textStatus, errorThrown);
        }
    });
}

function populateNotificationsList(notifications) {
    const list = document.getElementById('notifications-list');
    if (!list) return;
    list.innerHTML = '';

    notifications.forEach(notification => {
        const li = document.createElement('li');
        li.className = 'bg-gray-700 p-2 rounded text-white';
        li.innerHTML = `
            <strong>${notification.alert_name}</strong><br>
            ${notification.message}<br>
            <small>${notification.time}</small>
        `;
        list.appendChild(li);
    });
}

function updateNotificationCounter(count) {
    const counter = document.getElementById('notification-counter');
    if (!counter) return;
    if (count > 0) {
        counter.textContent = count;
        counter.classList.remove('hidden');
    } else {
        counter.classList.add('hidden');
    }
}


document.getElementById('notifications-tab')?.addEventListener('click', function () {
    const alertsTab = document.getElementById('alerts-tab');
    const notificationsTab = document.getElementById('notifications-tab');
    const dataFeedTab = document.getElementById('data-feed-tab');
    const alertsContent = document.getElementById('alerts-content');
    const notificationsContent = document.getElementById('notifications-content');
    const dataFeedContent = document.getElementById('data-feed-content');

    notificationsTab.classList.add('active-tab');
    notificationsTab.classList.remove('inactive-tab');
    alertsTab?.classList.remove('active-tab');
    alertsTab?.classList.add('inactive-tab');
    dataFeedTab?.classList.remove('active-tab');
    dataFeedTab?.classList.add('inactive-tab');

    alertsContent?.classList.add('hidden');
    notificationsContent?.classList.remove('hidden');
    dataFeedContent?.classList.add('hidden');

    const deviceId = getDeviceIdFromUrl();
    fetch(`/mark-notifications-seen/${deviceId}`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            updateNotificationCounter(0);
        }
    })
    .catch(error => console.error('Error marking notifications as seen:', error));
});

setInterval(() => {
    const deviceId = getDeviceIdFromUrl();
    fetchDeviceData(deviceId);
    fetchDeviceCharts(deviceId);
    fetchNotifications(deviceId);
    generateChartsForDevice(deviceId);
}, 5 * 60 * 1000);



function generateChartsForDevice(deviceId) {
    fetch(`/device_data_last_20/${deviceId}`, {
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.error) {
            showError(data.error);
            return;
        }

        if (data.length === 0) {
            console.log('No data available for the selected device.');
            return;
        }

        const xAxisParam = 'time';
        const yAxisParams = Object.keys(data[0].data);
        const xAxisValues = data.map(point => point[xAxisParam]);

        document.getElementById('chart_response').innerHTML = '';

        const gridContainer = document.createElement('div');
        gridContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
        document.getElementById('chart_response').appendChild(gridContainer);

        yAxisParams.forEach(param => {
            const paramData = data.map(point => point.data[param]);

            const chartContainer = document.createElement('div');
            chartContainer.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
            chartContainer.innerHTML = `
                <h3 class="text-lg font-semibold">${titleCase(param)}</h3>
                <canvas id="chart_${param}"></canvas>
            `;
            gridContainer.appendChild(chartContainer);

            const ctx = document.getElementById(`chart_${param}`).getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xAxisValues,
                    datasets: [{
                        label: titleCase(param),
                        data: paramData,
                        backgroundColor: getRandomColor(),
                        borderColor: getRandomColor(),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: titleCase(xAxisParam) }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });

        const chartResponseDiv = document.getElementById('chart_response');
        if (chartResponseDiv) {
            while (chartResponseDiv.firstChild) {
                chartResponseDiv.parentNode.insertBefore(chartResponseDiv.firstChild, chartResponseDiv);
            }
            chartResponseDiv.remove();
        }
    })
    .catch(error => {
        console.error('Fetch error during chart generation:', error);
    });
}


// Call the function with a valid deviceId when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const deviceId = getDeviceIdFromUrl();
    generateChartsForDevice(deviceId);
});

// Handle the All Data tab click
document.getElementById('all-data-tab').addEventListener('click', function () {
    document.getElementById('all-data-tab').classList.add('active-tab');
    document.getElementById('all-data-tab').classList.remove('inactive-tab');
    document.getElementById('alerts-tab').classList.remove('active-tab');
    document.getElementById('alerts-tab').classList.add('inactive-tab');
    document.getElementById('notifications-tab').classList.remove('active-tab');
    document.getElementById('notifications-tab').classList.add('inactive-tab');

    document.getElementById('alerts-content').classList.add('hidden');
    document.getElementById('notifications-content').classList.add('hidden');
    document.getElementById('all-data-content').classList.remove('hidden');

    showLoader();

    const deviceId = getDeviceIdFromUrl();
    fetch(`/device_data_all/${deviceId}`, {
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })
    .then(response => response.json())
    .then(data => {
        const allDataList = document.getElementById('all-data-list');
        allDataList.innerHTML = '';

        data.forEach(record => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700';

            const timeCell = document.createElement('td');
            timeCell.className = 'px-4 py-2 border-b border-gray-600';
            timeCell.textContent = record.time;

            const paramsCell = document.createElement('td');
            paramsCell.className = 'px-4 py-2 border-b border-gray-600';
            const paramsList = Object.entries(record.data)
                .map(([key, value]) => `${key}: ${value}`)
                .join(', ');
            paramsCell.textContent = paramsList;

            row.appendChild(timeCell);
            row.appendChild(paramsCell);
            allDataList.appendChild(row);
        });

        hideLoader();
    })
    .catch(error => {
        console.error('Error fetching all device data:', error);
        hideLoader();
        showError('Error fetching device data');
    });
});


// Multi-step Hopscotch Tour Function
function startMultiStepTour(steps) {
    document.addEventListener('DOMContentLoaded', function () {
        const tourSteps = steps.map(step => ({
            target: step.targetId,
            title: step.title,
            content: step.content,
            placement: step.placement || 'bottom',
        }));

        const tour = {
            id: "multi-step-tour",
            steps: tourSteps,
            showPrevButton: true,
            scrollTopMargin: 100
        };

        hopscotch.startTour(tour);

        if (steps.length > 0) {
            document.getElementById(steps[0].targetId)
                .scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
}

// Send demo device data
document.getElementById('send-demo-data-btn').addEventListener('click', function () {
    const url = document.getElementById('device-webhook-url').textContent;

    fetch(url)
        .then(response => {
            if (response.ok) {
                alert('Demo device data sent successfully!');
                window.location.reload();
            } else {
                alert('Failed to send demo device data.');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
});

// Initial onboarding tour
startMultiStepTour([
    {
        targetId: 'device-name',
        title: 'Device Information',
        content: 'This section defines the Device Name, followed by Device ID, Device Type & Device Description.',
        placement: 'right'
    },
    {
        targetId: 'device-webhook-url',
        title: 'Point Device To This URL',
        content: 'Make your IoT Device call this URL format, changing the parameters and values.',
        placement: 'left'
    },
    {
        targetId: 'send-demo-data-btn',
        title: 'Initiate Demo Device Ping',
        content: 'This mimics a call from your IoT device to our platform.',
        placement: 'left'
    },
    {
        targetId: 'alerts-content',
        title: 'Set Notification Alerts',
        content: 'Create alerts for this device. This only works after data is received.',
        placement: 'left'
    },
    {
        targetId: 'alert-list',
        title: 'Alert List',
        content: 'All configured alerts will be shown here.',
        placement: 'bottom'
    },
    {
        targetId: 'notifications-tab',
        title: 'Notifications List',
        content: 'View all alert notifications here after setting alerts.',
        placement: 'left'
    },
    {
        targetId: 'device-data-points',
        title: 'Device Data Points',
        content: 'Displays the latest data fetched from the device.',
        placement: 'top'
    },
    {
        targetId: 'chart_device_feed_section',
        title: 'Device Data Point Charts',
        content: 'Shows charts for each parameter based on the last 20 records.',
        placement: 'top'
    },
    {
        targetId: 'add-data-btn',
        title: 'Create A New Device Data Chart',
        content: 'Add custom data charts using selected X & Y Axis.',
        placement: 'left'
    }
]);


// Additional onboarding tour for Add Device Page
document.getElementById('add-device-btn')?.addEventListener('click', function () {
    startMultiStepTour([
        {
            targetId: 'device-id',
            title: 'Numerical Unique Device ID',
            content: 'Add your unique numerical device id.',
            placement: 'right'
        },
        {
            targetId: 'device-name',
            title: 'Point Device To This URL',
            content: 'To receive data for this device, point your IoT Device to this URL format with appropriate params.',
            placement: 'left'
        }
    ]);
});

    </script>
             
</body>

</html>
