<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ device[1] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .hidden {
            display: none;
        }

        .loader {
            border-top-color: transparent;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar {
            display: none;
        }

        @media (min-width: 1024px) {
            .sidebar {
                display: block;
            }
        }

        .transform {
            transform: translateX(-100%);
        }

        .transform-active {
            transform: translateX(0);
        }

        .transition-transform {
            transition: transform 0.3s ease-in-out;
        }

        .hover-effect:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.1);
        }

        .card-border {
            border: 2px solid white;
            border-radius: 0.5rem;
        }

        .active-tab {
            background-color: #3b82f6 !important;
        }

        .inactive-tab {
            background-color: #4b5563 !important;
        }
    </style>


<link href="https://cdn.jsdelivr.net/npm/hopscotch@0.3.1/dist/css/hopscotch.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hopscotch@0.3.1/dist/js/hopscotch.min.js"></script>
<style>
    .hopscotch-bubble-container {
        max-width: 250px; /* Adjust the width to fit within your layout */
        overflow: hidden;
    }
    
    .hopscotch-bubble-arrow {
        display: none; /* Optionally, hide the arrow if it's causing layout issues */
    }
</style>

</head>

<body class="bg-gray-900 min-h-screen flex flex-col ">

    <!-- Navigation Bar -->
    <nav class="bg-gradient-to-r from-purple-800 to-indigo-900 shadow-lg p-4 flex justify-between items-center relative">
        <div class="text-lg font-semibold text-white">IoT-InQube Dashboard</div>
        <div class="flex space-x-2 items-center">
            <div class="relative">
                <button id="menu-btn" class="bg-gray-800 text-white px-4 py-2 rounded-lg">Menu</button>
                <div id="desktop-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 text-white shadow-lg">
                    <ul>
                        
                        <li class="mb-4 p-2 hover:bg-gray-700">
                            <a href="/dashboard" class="text-gray-400 hover:text-indigo-500">Devices</a>
                        </li>
                        <li class="mb-4 p-2 hover:bg-gray-700">
                            <a href="/profile_settings" class="text-gray-400 hover:text-indigo-500">Settings</a>
                        </li>
                    </ul>
                </div>
            </div>
            <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
        </div>
    </nav>

    <!-- Sidebar for Mobile -->
    <aside id="mobile-sidebar" class="bg-gray-800 w-64 p-4 shadow-lg fixed inset-y-0 left-0 transform transition-transform lg:hidden -translate-x-full">
        <div class="flex justify-end mb-4">
            <button id="close-sidebar-btn" class="bg-gray-800 text-white px-2 py-1">X</button>
        </div>
        <nav>
            <ul>
                
                <li class="mb-4">
                    <a href="/dashboard" class="text-gray-400 hover:text-indigo-500">Devices</a>
                </li>
                <li class="mb-4">
                    <a href="/profile_settings" class="text-gray-400 hover:text-indigo-500">Settings</a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Sidebar for Desktop -->
    <aside id="desktop-sidebar" class="bg-gray-800 w-64 p-4 shadow-lg hidden lg:block">
        <nav>
            <ul>
                
                <li class="mb-4">
                    <a href="/dashboard" class="text-gray-400 hover:text-indigo-500">Devices</a>
                </li>
                <li class="mb-4">
                    <a href="/profile_settings" class="text-gray-400 hover:text-indigo-500">Settings</a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex flex-grow">
        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h1 id="device-name" class="text-3xl font-semibold text-gray-200 mb-4">{{ device[1] }}</h1>
                        <p id="device-details" class="text-gray-400 mb-8">{{ device[0] }}<br>{{ device[2] }}<br>{{ device[3] }}</p>
                    </div>
                    <button id="add-data-btn" class="bg-green-500 text-white px-4 py-2 rounded flex items-center mb-4 md:mb-0">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Create New Data Chart
                    </button>
                </div>
            </div>

            <br>

            <div class="bg-gray-800 p-6 rounded-lg shadow-lg" id="chart_device_feed_section">

                <div class="col-span-12 md:col-span-8 bg-gray-800 p-6 rounded-lg shadow-lg text-white">
                        
                    <div id="chart_response"></div>
                
                </div>
            </div>

            <!-- Main Container for Device Data Points and Additional Blocks --><br>
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                <!-- Device Data Points Card (Width 8) -->
                <div class="col-span-12 md:col-span-8 bg-gray-800 p-6 rounded-lg shadow-lg text-white">
                    <h2 class="text-2xl font-semibold mb-4">Device Data Points</h2>
                    <div id="device-data-points" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {% for key, value in data_points.items() %}
                        <div class="bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border">
                            <h3 class="text-lg font-semibold">{{ key }}</h3>
                            <p class="text-2xl">{{ value }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                </div>

                

                <!-- Additional Block (Width 4) -->
                <div class="col-span-12 md:col-span-4 space-y-6">
                    <!-- Device Webhook Block -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-white">
                        <h2 class="text-2xl font-semibold mb-4">Device Webhook</h2>
                        <p id="device-webhook-url" class="break-words mb-4">
                            http://iot.mygreenqube.com:5000/data?device_id=26041990&temperature=25&humidity=60&pressure=1013
                        </p>
                        <button id="send-demo-data-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            Send Demo Device Data
                        </button>
                    </div>
                    
                    
                    
                    

                    <!-- Tabs Block -->
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg ">
                        <h2 class="text-2xl font-semibold mb-4 text-white">Device Management</h2>
                        <div class="flex flex-col space-y-4">
                            <!-- Tabs Navigation -->
                            <nav class="flex space-x-4 mb-4">
                                <button id="alerts-tab" class="bg-blue-500 text-white px-4 py-2 rounded active-tab text-white">Alerts</button>

                                <button id="notifications-tab" class="bg-gray-700 text-white px-4 py-2 rounded inactive-tab relative">
                                    Notifications
                                    <span id="notification-counter" class="absolute top-0 right-0 bg-red-600 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center hidden">0</span>
                                </button>

                                <button id="data-feed-tab" class="bg-gray-700 text-white px-4 py-2 rounded inactive-tab" hidden>Data Feed</button>
                            </nav>utton id="all-device-data-tab" class="bg-gray-700 text-white px-4 py-2 rounded inactive-tab">All Device Data</button>
                            </nav>
                            <!-- Alerts Content -->
                             <!-- Alerts Content -->
                             <div id="alerts-content">
                                <h3 class="text-xl font-semibold mb-2 text-white">Create Alert</h3>
                                <form id="alert-form">t-semibold mb-2 text-white">Create Alert</h3>
                                    <div class="mb-4">
                                        <label for="alert-name" class="block text-gray-400">Alert Name</label>
                                        <input type="text" id="alert-name" class="w-full px-3 py-2 border rounded-lg" required>
                                    </div>nput type="text" id="alert-name" class="w-full px-3 py-2 border rounded-lg" required>
                                    <div class="mb-4">
                                        <label for="alert-parameter" class="block text-gray-400">Parameter</label>
                                        <select id="alert-parameter" class="w-full px-3 py-2 border rounded-lg" required>
                                            <!-- Options will be dynamically added -->3 py-2 border rounded-lg" required>
                                        </select>Options will be dynamically added -->
                                    </div>select>
                                    <div class="mb-4">
                                        <label for="alert-gate" class="block text-gray-400">Alert Logic</label>
                                        <select id="alert-gate" name="alert_gate" class="w-full px-3 py-2 border rounded-lg" required>
                                            <!-- Options will be dynamically added -->s="w-full px-3 py-2 border rounded-lg" required>
                                             <option value="Greater Than">Greater Than</option>
                                             <option value="Less Than">Less Than</option>ption>
                                             <option value="Equal To">Equal to</option>n>
                                        </select>ion value="Equal To">Equal to</option>
                                    </div>select>
                                    <div class="mb-4">
                                        <label for="alert-value" class="block text-gray-400">Value</label>
                                        <input type="number" id="alert-value" class="w-full px-3 py-2 border rounded-lg" required>
                                    </div>nput type="number" id="alert-value" class="w-full px-3 py-2 border rounded-lg" required>
                                    <button type="button" onClick="CreateAlert();" class="bg-blue-500 text-white px-4 py-2 rounded">Create Alert</button>
                                </form>tton type="button" onClick="CreateAlert();" class="bg-blue-500 text-white px-4 py-2 rounded">Create Alert</button>
                                <h3 class="text-xl font-semibold mt-4 text-white">Alert List</h3>
                                <ul id="alert-list" class="space-y-2">text-white">Alert List</h3>
                                    <!-- Alerts will be dynamically added here -->
                                </ul>!-- Alerts will be dynamically added here -->
                            </div>ul>
                            </div>
                            <!-- Notifications Content -->
                            <div id="notifications-content" class="hidden">
                                <h3 class="text-xl font-semibold mb-2 text-white">Notifications</h3>
                                <ul id="notifications-list" class="space-y-2 text-white">ations</h3>
                                    <li class="bg-gray-700 p-2 rounded">Sample Notification 1</li>
                                    <li class="bg-gray-700 p-2 rounded">Sample Notification 2</li>
                                    <li class="bg-gray-700 p-2 rounded">Sample Notification 3</li>
                                </ul>li class="bg-gray-700 p-2 rounded">Sample Notification 3</li>
                            </div>ul>
                            </div>
                            <!-- Data Feed Content -->
                            <div id="data-feed-content" class="hidden" hidden>
                                <h3 class="text-xl font-semibold mb-2">Data Feed</h3>
                                <!-- Data Feed will be dynamically added here -->/h3>
                            </div>-- Data Feed will be dynamically added here -->
                            </div>
                        </div>-- All Device Data Content -->
                    </div>  <div id="all-device-data-content" class="hidden">
                </div>          <h3 class="text-xl font-semibold mb-2 text-white">All Device Data</h3>
            </div>              <table class="table-auto w-full text-white">
                                    <thead>
            <!-- Device Charts Card --> <tr>
            <div class="bg-gray-800 p-6 mt-6 rounded-lg shadow-lg text-white">h>
                <h2 class="text-2xl font-semibold mb-4">Device Charts</h2>>
                <div id="device-charts" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Chart cards will be dynamically added here -->
                </div>              <tbody id="all-device-data-list">
            </div>                      <!-- Records will be dynamically added here -->
        </main>                     </tbody>
    </div>                      </table>
                            </div>
    <!-- Loader Modal -->
    <div id="loader-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="flex flex-col items-center">
            <div class="loader border-4 border-blue-500"></div>
            <p class="text-white mt-4">Please Wait...</p>
        </div>
    </div>  <!-- Device Charts Card -->
            <div class="bg-gray-800 p-6 mt-6 rounded-lg shadow-lg text-white">
    <!-- Add Data Chart Modal -->xl font-semibold mb-4">Device Charts</h2>
<div id="add-data-chart-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg mx-4">
        <h2 class="text-xl font-semibold mb-4" style="color: black;">Create New Data Chart</h2>
        <form id="add-data-chart-form">
            <div class="mb-4">
                <label for="chart-name" class="block text-gray-700">Chart Name</label>
                <input type="text" id="chart-name" name="chartName" class="w-full px-3 py-2 border rounded-lg" required>
            </div>dal -->
            <div class="mb-4">ss="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
                <label for="chart-type" class="block text-gray-700">Chart Type</label>
                <select id="chart-type" name="chartType" class="w-full px-3 py-2 border rounded-lg" required>
                    <option value="line">Line</option>/p>
                    <option value="bar">Bar</option>
                    <option value="radar">Radar</option>
                    <option value="pie">Pie</option>
                    <option value="doughnut">Doughnut</option>
                </select>odal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
            </div>-white p-6 rounded-lg shadow-lg w-full max-w-lg mx-4">
        <h2 class="text-xl font-semibold mb-4" style="color: black;">Create New Data Chart</h2>
            <div class="mb-4">rt-form">
                <input type="checkbox" id="live-data" name="liveData">
                <label for="live-data" class="text-gray-700">Get Live Data</label>bel>
            </div>nput type="text" id="chart-name" name="chartName" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div id="date-range-fields" class="mb-4">
                <div class="mb-4">type" class="block text-gray-700">Chart Type</label>
                    <label for="start-date" class="block text-gray-700">Start Date</label>unded-lg" required>
                    <input type="date" id="start-date" name="startDate" class="w-full px-3 py-2 border rounded-lg">
                </div>ption value="bar">Bar</option>
                <div class="mb-4">"radar">Radar</option>
                    <label for="end-date" class="block text-gray-700">End Date</label>
                    <input type="date" id="end-date" name="endDate" class="w-full px-3 py-2 border rounded-lg">
                </div>ct>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700">X-Axis Parameter</label>
                <div id="x-axis-params" class="grid grid-cols-1 gap-2">ata</label>
                    <!-- Radio buttons will be dynamically added here -->
                </div>
            </div>d="date-range-fields" class="mb-4">
                <div class="mb-4">
            <div class="mb-4">="start-date" class="block text-gray-700">Start Date</label>
                <label class="block text-gray-700">Y-Axis Parameters</label>s="w-full px-3 py-2 border rounded-lg">
                <div id="y-axis-params" class="grid grid-cols-2 gap-2">
                    <!-- Checkboxes will be dynamically added here -->
                </div>abel for="end-date" class="block text-gray-700">End Date</label>
            </div>  <input type="date" id="end-date" name="endDate" class="w-full px-3 py-2 border rounded-lg">
                </div>
            <div class="flex justify-end">
                <button type="button" id="cancel-add-data-chart" class="bg-gray-500 text-white px-4 py-2 rounded-lg mr-2">Cancel</button>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Create Chart</button>
            </div>abel class="block text-gray-700">X-Axis Parameter</label>
        </form> <div id="x-axis-params" class="grid grid-cols-1 gap-2">
    </div>          <!-- Radio buttons will be dynamically added here -->
</div>          </div>
            </div>
    
            <div class="mb-4">
    <!-- Delete Confirmation Modal -->xt-gray-700">Y-Axis Parameters</label>
    <div id="delete-confirmation-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md mx-4">
            <h2 class="text-xl font-semibold mb-4" style="color: black;">Delete Confirmation</h2>
            <p id="delete-confirmation-message" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button type="button" id="cancel-delete" class="bg-gray-500 text-white px-4 py-2 rounded-lg mr-2">Cancel</button>
                <button type="button" id="confirm-delete" class="bg-red-500 text-white px-4 py-2 rounded-lg">Delete</button>ncel</button>
            </div>utton type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Create Chart</button>
        </div>div>
    </div>form>
    </div>
    <script>
        let selectedChartId = null;
    
function titleCase(str) {
    return str.toLowerCase().split(' ').map(function(word) {
        return word.charAt(0).toUpperCase() + word.slice(1); flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    }).join(' ');s="bg-white p-6 rounded-lg shadow-lg w-full max-w-md mx-4">
}           <h2 class="text-xl font-semibold mb-4" style="color: black;">Delete Confirmation</h2>
            <p id="delete-confirmation-message" class="text-gray-700 mb-4"></p>
function showError(message) {justify-end">
    alert(message);tton type="button" id="cancel-delete" class="bg-gray-500 text-white px-4 py-2 rounded-lg mr-2">Cancel</button>
}               <button type="button" id="confirm-delete" class="bg-red-500 text-white px-4 py-2 rounded-lg">Delete</button>
            </div>
function showDeleteConfirmation(chartId, chartName) {
    selectedChartId = chartId;
    document.getElementById('delete-confirmation-message').textContent = `Are you sure you want to delete the chart "${chartName}"?`;
    document.getElementById('delete-confirmation-modal').classList.remove('hidden');
}       let selectedChartId = null;

function deleteChart(chartId) {
    fetch(`/delete-chart/${chartId}`, {.map(function(word) {
        method: 'POST'arAt(0).toUpperCase() + word.slice(1);
    }).join(' ');
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }(message);
        return response.json();
    })
    .then(data => {Confirmation(chartId, chartName) {
        if (data.error) {rtId;
            showError(data.error);e-confirmation-message').textContent = `Are you sure you want to delete the chart "${chartName}"?`;
        } else {ElementById('delete-confirmation-modal').classList.remove('hidden');
            document.querySelector(`[data-chart-id="${chartId}"]`).parentElement.remove();
        }
    })on deleteChart(chartId) {
    .catch(error => {art/${chartId}`, {
        console.error('There was a problem with the fetch operation:', error);
        // showError('An error occurred while deleting the chart.');
    });en(response => {
}       if (!response.ok) {
            throw new Error('Network response was not ok');
document.addEventListener('DOMContentLoaded', () => {
    const deviceId = getDeviceIdFromUrl();
    fetchDeviceData(deviceId)
        .then(data => {
            if (data && data.parameters) {
                fetchDeviceCharts(deviceId);
                generateChartsForDevice(deviceId);
                fetchAlerts(deviceId);ata-chart-id="${chartId}"]`).parentElement.remove();
                populateParams(data.parameters); // Assume the parameters are part of the device data response
            } else {
                console.error('Device data or parameters are undefined.');
            }le.error('There was a problem with the fetch operation:', error);
        }) showError('An error occurred while deleting the chart.');
        .catch(error =>console.error(error));
});

document.addEventListener('DOMContentLoaded', () => {
function populateParams(params) {romUrl();
    const xAxisParamsContainer = document.getElementById('x-axis-params');
    const yAxisParamsContainer = document.getElementById('y-axis-params');
            if (data && data.parameters) {
    // Populate both X-axis parameters (radio buttons) and Y-axis parameters (checkboxes)
    params.forEach(param => {sForDevice(deviceId);
        // X-axis radio buttonviceId);
        const radio = document.createElement('input');sume the parameters are part of the device data response
        radio.type = 'radio';
        radio.id = `x-axis-param-${param}`;or parameters are undefined.');
        radio.name = 'xAxisParam';
        radio.value = param;
        radio.required = true;.error(error));
        const radioLabel = document.createElement('label');
        radioLabel.htmlFor = radio.id;
        radioLabel.textContent = param;
        const radioDiv = document.createElement('div');
        radioDiv.appendChild(radio);ument.getElementById('x-axis-params');
        radioDiv.appendChild(radioLabel);.getElementById('y-axis-params');
        xAxisParamsContainer.appendChild(radioDiv);
    // Populate both X-axis parameters (radio buttons) and Y-axis parameters (checkboxes)
        // Y-axis checkbox> {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';teElement('input');
        checkbox.id = `y-axis-param-${param}`;
        checkbox.name = 'yAxisParams';am}`;
        checkbox.value = param;m';
        const checkboxLabel = document.createElement('label');
        checkboxLabel.htmlFor = checkbox.id;
        checkboxLabel.textContent = param;Element('label');
        const checkboxDiv = document.createElement('div');
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(checkboxLabel);('div');
        yAxisParamsContainer.appendChild(checkboxDiv);
    }); radioDiv.appendChild(radioLabel);
}       xAxisParamsContainer.appendChild(radioDiv);

document.getElementById('add-data-btn').addEventListener('click', () => {
    document.getElementById('add-data-chart-modal').classList.remove('hidden');
});     checkbox.type = 'checkbox';
        checkbox.id = `y-axis-param-${param}`;
document.getElementById('cancel-add-data-chart').addEventListener('click', () => {
    document.getElementById('add-data-chart-modal').classList.add('hidden');
});     const checkboxLabel = document.createElement('label');
        checkboxLabel.htmlFor = checkbox.id;
        checkboxLabel.textContent = param;
        const checkboxDiv = document.createElement('div');
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(checkboxLabel);
        yAxisParamsContainer.appendChild(checkboxDiv);
    });
}

document.getElementById('add-data-btn').addEventListener('click', () => {
    document.getElementById('add-data-chart-modal').classList.remove('hidden');
});

document.getElementById('add-data-chart-form').addEventListener('submit', function(event) {
    event.preventDefault();('add-data-chart-modal').classList.add('hidden');
});
    const deviceId = getDeviceIdFromUrl();
    const chartName = document.getElementById('chart-name').value;
    const chartType = document.getElementById('chart-type').value;
    const liveData = document.getElementById('live-data').checked;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    const xAxisParam = document.querySelector('input[name="xAxisParam"]:checked').value;
    const yAxisParams = Array.from(document.querySelectorAll('input[name="yAxisParams"]:checked')).map(checkbox => checkbox.value);

    if ((liveData && (startDate || endDate)) || (!liveData && (!startDate || !endDate))) {
        showError('Either select live data or provide a valid date range.');
        return;
    }
document.getElementById('add-data-chart-form').addEventListener('submit', function(event) {
    if (!xAxisParam || !yAxisParams) {
        alert('Please select an option for both the axis.');
        return;eId = getDeviceIdFromUrl();
    }onst chartName = document.getElementById('chart-name').value;
    const chartType = document.getElementById('chart-type').value;
    let fetchUrl = `/device_data_range/${deviceId}?start_date=${startDate}&end_date=${endDate}`;
    if (liveData) { = document.getElementById('start-date').value;
        fetchUrl = `/device_data_last_20/${deviceId}`;).value;
    }onst xAxisParam = document.querySelector('input[name="xAxisParam"]:checked').value;
    const yAxisParams = Array.from(document.querySelectorAll('input[name="yAxisParams"]:checked')).map(checkbox => checkbox.value);
    fetch(fetchUrl, {
        headers: {&& (startDate || endDate)) || (!liveData && (!startDate || !endDate))) {
            'Authorization': 'Bearer ' + localStorage.getItem('token')ge.');
        }eturn;
    })
    .then(response => {
        if (!response.ok) {isParams) {
            throw new Error('Network response was not ok');;
        }eturn;
        return response.json();
    })
    .then(data => {`/device_data_range/${deviceId}?start_date=${startDate}&end_date=${endDate}`;
        if (data.error) {
            showError(data.error);ast_20/${deviceId}`;
        } else {
            if (data.length === 0) {
                showError('No data available for the selected parameters.');
                return;
            }Authorization': 'Bearer ' + localStorage.getItem('token')
        }
            const xAxisValues = data.map(point => point.data[xAxisParam]);
            const yAxisValues = data.map(point => {
                return yAxisParams.reduce((acc, param) => {
                    acc[param] = point.data[param];ot ok');
                    return acc;
                }, {});.json();
            });
    .then(data => {
            fetch('/create-chart', {
                method: 'POST',r);
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },turn;
                body: JSON.stringify({
                    device_id: deviceId,
                    chart_name: chartName,oint => point.data[xAxisParam]);
                    chart_type: chartType,oint => {
                    x_axis_params: { label: xAxisParam, data: xAxisValues }, // Include label for x_axis_params
                    is_live: liveData,.data[param];
                    y_axis_params: yAxisParams.map(param => ({ label: param, data: yAxisValues.map(value => value[param]) })),
                    position: document.querySelectorAll('#device-charts > div').length
                })
            })
            .then(response => {t', {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }   'Content-Type': 'application/json',
                return response.json();earer ' + localStorage.getItem('token')
            })  },
            .then(data => {stringify({
                if (data.error) {viceId,
                    showError(data.error);
                } else rt_type: chartType,
                {   x_axis_params: { label: xAxisParam, data: xAxisValues }, // Include label for x_axis_params
                    fetchDeviceCharts(deviceId);
                    generateChartsForDevice(deviceId);am => ({ label: param, data: yAxisValues.map(value => value[param]) })),
                    document.getElementById('add-data-chart-modal').classList.add('hidden');
                })
            })
            .catch(error => { {
                console.error('There was a problem with the fetch operation:', error);
                showError('An error occurred while creating the chart.');
            }); }
        }       return response.json();
    })      })
    .catch(error => {a => {
        console.error('There was a problem with the fetch operation:', error);
        // showError('An error occurred while fetching device data.');
    });         } else 
});             {
                    fetchDeviceCharts(deviceId);
                    generateChartsForDevice(deviceId);
                    document.getElementById('add-data-chart-modal').classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                showError('An error occurred while creating the chart.');
            });
        }
    })
document.getElementById('confirm-delete').addEventListener('click', () => {
    deleteChart(selectedChartId);a problem with the fetch operation:', error);
    document.getElementById('delete-confirmation-modal').classList.add('hidden');
}); });
});
document.getElementById('cancel-delete').addEventListener('click', () => {
    document.getElementById('delete-confirmation-modal').classList.add('hidden');
});



        document.getElementById('confirm-delete').addEventListener('click', () => {
            deleteChart(selectedChartId);
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
        });
    
        document.getElementById('cancel-delete').addEventListener('click', () => {
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
        });t.getElementById('delete-confirmation-modal').classList.add('hidden');
    
        document.getElementById('menu-btn').addEventListener('click', function () {
            const mobileSidebar = document.getElementById('mobile-sidebar');
            const desktopDropdown = document.getElementById('desktop-dropdown');;
            if (window.innerWidth >= 1024) {
                desktopDropdown.classList.toggle('hidden');
            } else {
                mobileSidebar.classList.toggle('transform');
                mobileSidebar.classList.toggle('transform-active');'click', () => {
            }eleteChart(selectedChartId);
        }); document.getElementById('delete-confirmation-modal').classList.add('hidden');
        });
        document.getElementById('close-sidebar-btn').addEventListener('click', function () {
            const mobileSidebar = document.getElementById('mobile-sidebar');) => {
            mobileSidebar.classList.add('transform');ion-modal').classList.add('hidden');
            mobileSidebar.classList.remove('transform-active');
        });
        document.getElementById('menu-btn').addEventListener('click', function () {
        document.addEventListener('click', function (event) {bile-sidebar');
            const desktopDropdown = document.getElementById('desktop-dropdown');
            const menuBtn = document.getElementById('menu-btn');
            const isClickInside = desktopDropdown.contains(event.target) || menuBtn.contains(event.target);
            } else {
            if (!isClickInside && !desktopDropdown.classList.contains('hidden')) {
                desktopDropdown.classList.add('hidden');m-active');
            }
        });
    
        document.getElementById('logout-btn').addEventListener('click', function () {on () {
            showLoader();idebar = document.getElementById('mobile-sidebar');
            fetch('/logout', { method: 'POST' })rm');
                .then(response => {.remove('transform-active');
                    hideLoader();
                    if (response.ok) {
                        window.location.href = '/'; (event) {
                    } else {pdown = document.getElementById('desktop-dropdown');
                        showError('Logout failed. Please try again.');
                    }lickInside = desktopDropdown.contains(event.target) || menuBtn.contains(event.target);
                })
                .catch(error => { !desktopDropdown.classList.contains('hidden')) {
                    hideLoader();lassList.add('hidden');
                    showError('An error occurred. Please try again.');
                });
        });
        document.getElementById('logout-btn').addEventListener('click', function () {
        function showLoader() {
            const loaderModal = document.getElementById('loader-modal');
            loaderModal.classList.remove('hidden');
        }           hideLoader();
                    if (response.ok) {
        function hideLoader() {location.href = '/';
            const loaderModal = document.getElementById('loader-modal');
            loaderModal.classList.add('hidden');. Please try again.');
        }           }
                })
        // Optional: Refresh charts and data points every 5 minutes
        setInterval(() => {der();
            const deviceId = getDeviceIdFromUrl();Please try again.');
            fetchDeviceData(deviceId);
            fetchDeviceCharts(deviceId);
            generateChartsForDevice(deviceId);
        }, 5 * 60 * 1000);r() {
            const loaderModal = document.getElementById('loader-modal');
            loaderModal.classList.remove('hidden');
        function updateDeviceCharts(charts) {
    const deviceCharts = document.getElementById('device-charts');
    deviceCharts.innerHTML = '';
            const loaderModal = document.getElementById('loader-modal');
    charts.forEach(chart => {List.add('hidden');
        const chartCard = document.createElement('div');
        chartCard.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
        chartCard.innerHTML = `arts and data points every 5 minutes
            <h3 class="text-lg font-semibold">${chart.chart_name}</h3>
            <p class="text-md">${chart.chart_type}</p>
            <canvas id="chart-${chart.id}"></canvas>
            <button class="bg-red-500 text-white px-2 py-1 rounded text-sm mt-2 delete-chart-btn" data-chart-id="${chart.id}" data-chart-name="${chart.chart_name}">Delete</button>
        `;  generateChartsForDevice(deviceId);
        deviceCharts.appendChild(chartCard);
    
        const xAxisParams = chart.x_axis_params;
        function updateDeviceCharts(charts) {
        const ctx = document.getElementById(`chart-${chart.id}`).getContext('2d');
        new Chart(ctx, {ML = '';
            type: chart.chart_type,
            data: {chart => {
                labels: xAxisParams.data, // Use the data part of x_axis_params for X-Axis labels
                datasets: chart.y_axis_params.map(param => ({ to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
                    label: param.label,
                    data: param.data,emibold">${chart.chart_name}</h3>
                    backgroundColor: getRandomColor(),
                    borderColor: getRandomColor(),s>
                    borderWidth: 1500 text-white px-2 py-1 rounded text-sm mt-2 delete-chart-btn" data-chart-id="${chart.id}" data-chart-name="${chart.chart_name}">Delete</button>
                }))
            },Charts.appendChild(chartCard);
            options: {
                scales: { = chart.x_axis_params;
                    x: {
                        title: {ElementById(`chart-${chart.id}`).getContext('2d');
                            display: true,
                            text: xAxisParams.label // Set the label for the X-Axis
                        }
                    },: xAxisParams.data, // Use the data part of x_axis_params for X-Axis labels
                    y: {: chart.y_axis_params.map(param => ({
                        beginAtZero: true
                    }ata: param.data,
                }   backgroundColor: getRandomColor(),
            }       borderColor: getRandomColor(),
        });         borderWidth: 1
                }))
        document.querySelectorAll('.delete-chart-btn').forEach(button => {
            button.addEventListener('click', function () {
                const chartId = this.getAttribute('data-chart-id');
                const chartName = this.getAttribute('data-chart-name');
                showDeleteConfirmation(chartId, chartName);
            });             display: true,
        });                 text: xAxisParams.label // Set the label for the X-Axis
    });                 }
}                   },
                    y: {
                        beginAtZero: true
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }ent.querySelectorAll('.delete-chart-btn').forEach(button => {
            return color;ntListener('click', function () {
        }       const chartId = this.getAttribute('data-chart-id');
                const chartName = this.getAttribute('data-chart-name');
                showDeleteConfirmation(chartId, chartName);
        // Ensure chartConfigs is defined and accessible before this 
const chartConfigs = [
    {);
        start_date: '2024-08-01',
        end_date: '2024-08-19',
        chartInstance: null, 
        // This will hold the Chart.js instance after it's created
        // Other chart configuration options if needed
    }       let color = '#';
];          for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
function updateChartsPeriodically() {
    setInterval(() => {r;
        const deviceId = getDeviceIdFromUrl();
        fetch(`/device_data_range/${deviceId}?start_date=${chartConfigs[0].start_date}&end_date=${chartConfigs[0].end_date}`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }nfigs = [
        })
        .then(response => {8-01',
            if (!response.ok) {
                thrownewError('Network response was not ok');
            }is will hold the Chart.js instance after it's created
            return response.json();n options if needed
        })
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else if (data.length > 0) {
                const timestamps = data.map(point => point.time);
                const parameters = Object.keys(data[0].data); rtConfigs[0].start_date}&end_date=${chartConfigs[0].end_date}`, {
                // Get dynamic parameter names from the first data point
                // Dynamically set up the datasets for the chartm('token')
                const datasets = parameters.map(param => {
                    return {
                        label: param,
                        data: data.map(point =>parseFloat(point.data[param])),
                        // Customize the chart display settings here
                    };
                });response.json();
                
                // If the chart does not exist, create it
                if (!chartConfigs[0].chartInstance) {
                    const ctx = document.getElementById('yourChartId').getContext('2d');
                    chartConfigs[0].chartInstance = newChart(ctx, {
                        type: 'line', // or 'bar', 'pie', .time);
                        data: {s = Object.keys(data[0].data); 
                            labels: timestamps,from the first data point
                            datasets: datasetssets for the chart
                        },sets = parameters.map(param => {
                        options: {
                            // Add your chart options here
                        }ata: data.map(point =>parseFloat(point.data[param])),
                    }); // Customize the chart display settings here
                } else {
                    // If the chart already exists, update it
                    chartConfigs[0].chartInstance.data.labels = timestamps;
                    chartConfigs[0].chartInstance.data.datasets = datasets;
                    chartConfigs[0].chartInstance.update();
                }   const ctx = document.getElementById('yourChartId').getContext('2d');
            }       chartConfigs[0].chartInstance = newChart(ctx, {
            else {      type: 'line', // or 'bar', 'pie', 
                console.warn('No data available for the specified date range.');
            }               labels: timestamps,
        })                  datasets: datasets
        .catch(error => {,
            console.error('There was a problem with the fetch operation:', error);
            // showError('An error occurred while fetching device data.');
        });             }
    }, 5 * 60 * 1000); // 5 minutes
}               } else {
                    // If the chart already exists, update it
                    chartConfigs[0].chartInstance.data.labels = timestamps;
                    chartConfigs[0].chartInstance.data.datasets = datasets;
                    chartConfigs[0].chartInstance.update();
        document.addEventListener('DOMContentLoaded', () => {
            const deviceId = getDeviceIdFromUrl();
            fetchDeviceData(deviceId);
            fetchDeviceCharts(deviceId).then(generateChartsForDevice(deviceId));
        }); }
        })
        document.getElementById('alerts-tab').addEventListener('click', function () {
            document.getElementById('alerts-tab').classList.add('active-tab');or);
            document.getElementById('alerts-tab').classList.remove('inactive-tab');
            document.getElementById('notifications-tab').classList.remove('active-tab');
            document.getElementById('notifications-tab').classList.add('inactive-tab');
            document.getElementById('data-feed-tab').classList.remove('active-tab');
            document.getElementById('data-feed-tab').classList.add('inactive-tab');
    
            document.getElementById('alerts-content').classList.remove('hidden');
            document.getElementById('notifications-content').classList.add('hidden');
            document.getElementById('data-feed-content').classList.add('hidden');
        }); const deviceId = getDeviceIdFromUrl();
            fetchDeviceData(deviceId);
        document.getElementById('notifications-tab').addEventListener('click', function () {
            document.getElementById('notifications-tab').classList.add('active-tab');
            document.getElementById('notifications-tab').classList.remove('inactive-tab');
            document.getElementById('alerts-tab').classList.remove('active-tab');() {
            document.getElementById('alerts-tab').classList.add('inactive-tab');
            document.getElementById('data-feed-tab').classList.remove('active-tab');
            document.getElementById('data-feed-tab').classList.add('inactive-tab');ab');
            document.getElementById('notifications-tab').classList.add('inactive-tab');
            document.getElementById('alerts-content').classList.add('hidden');tab');
            document.getElementById('notifications-content').classList.remove('hidden');
            document.getElementById('data-feed-content').classList.add('hidden');
        }); document.getElementById('alerts-content').classList.remove('hidden');
            document.getElementById('notifications-content').classList.add('hidden');
        document.getElementById('data-feed-tab').addEventListener('click', function () {
            document.getElementById('data-feed-tab').classList.add('active-tab');
            document.getElementById('data-feed-tab').classList.remove('inactive-tab');
            document.getElementById('alerts-tab').classList.remove('active-tab');nction () {
            document.getElementById('alerts-tab').classList.add('inactive-tab');ab');
            document.getElementById('notifications-tab').classList.remove('active-tab'););
            document.getElementById('notifications-tab').classList.add('inactive-tab');
            document.getElementById('alerts-tab').classList.add('inactive-tab');
            document.getElementById('alerts-content').classList.add('hidden');tab');
            document.getElementById('notifications-content').classList.add('hidden');
            document.getElementById('data-feed-content').classList.remove('hidden');
        }); document.getElementById('alerts-content').classList.add('hidden');
            document.getElementById('notifications-content').classList.remove('hidden');
        // Fetch and update device datata-feed-content').classList.add('hidden');
        function fetchDeviceData(deviceId) {
            return fetch(`/device_data/${deviceId}`)
                .then(response => response.json())ddEventListener('click', function () {
                .then(data => {ById('data-feed-tab').classList.add('active-tab');
                    document.getElementById('device-name').textContent = data.device_name;
                    document.getElementById('device-details').innerHTML = `${data.device_id}<br>${data.device_type}<br>${data.device_description}`;
                    updateDeviceDataPoints(data.data_points);dd('inactive-tab');
                    populateYAxisParams(data.data_points, 'y-axis-params');active-tab');
                    populateXAxisParams(data.data_points, 'x-axis-params');ctive-tab');
                    updateDeviceWebhook(data.device_id, data.data_points);
                    populateAlertParameters(data.data_points);t.add('hidden');
                })nt.getElementById('notifications-content').classList.add('hidden');
                .catch(error => console.error('Error fetching device data:', error));
        });
    
        // Update device webhook URL-device-data-tab').addEventListener('click', function () {
        function updateDeviceWebhook(deviceId, dataPoints) {lassList.add('active-tab');
    // Fetch the current domain with protocol and portab').classList.remove('inactive-tab');
    let origin = window.location.origin;rts-tab').classList.remove('active-tab');
            document.getElementById('alerts-tab').classList.add('inactive-tab');
    // Check if dataPoints is empty('notifications-tab').classList.remove('active-tab');
    if (Object.keys(dataPoints).length === 0) {ons-tab').classList.add('inactive-tab');
        // Use demo datapoints if none are provided).classList.remove('active-tab');
        dataPoints = {etElementById('data-feed-tab').classList.add('inactive-tab');
            demo_temperature: '25',
            demo_humidity: '60',yId('alerts-content').classList.add('hidden');
            demo_pressure: '1013'Id('notifications-content').classList.add('hidden');
        };  document.getElementById('data-feed-content').classList.add('hidden');
    }       document.getElementById('all-device-data-content').classList.remove('hidden');

    // Construct the URL using the fetched origin
    let url = `${origin}/data?device_id=${deviceId}`;
            fetch(`/device_data_all/${deviceId}`, {
    for (const [key, value] of Object.entries(dataPoints)) {
        url += `&${key}=${value}`;': 'Bearer ' + localStorage.getItem('token')
    }           }
            })
    // Update the content of the element with the new URL
    document.getElementById('device-webhook-url').textContent = url;
}               const allDeviceDataList = document.getElementById('all-device-data-list');
                allDeviceDataList.innerHTML = '';

                data.forEach(record => {
        // Update device data pointsment.createElement('tr');
        function updateDeviceDataPoints(dataPoints) {
            const deviceDataPoints = document.getElementById('device-data-points');
            deviceDataPoints.innerHTML = '';-4 py-2">${JSON.stringify(record.data)}</td>
                    `;
            for (const [key, value] of Object.entries(dataPoints)) {
                const dataPointCard = document.createElement('div');
                dataPointCard.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
                dataPointCard.innerHTML = `Error fetching all device data:', error));
                    <h3 class="text-lg font-semibold">${key}</h3>
                    <p class="text-2xl">${value}</p>
                `;nd update device data
                deviceDataPoints.appendChild(dataPointCard);
            }eturn fetch(`/device_data/${deviceId}`)
        }       .then(response => response.json())
                .then(data => {
        // Populate Y-Axis parameters for chart creation').textContent = data.device_name;
        function populateYAxisParams(dataPoints, containerId) {nnerHTML = `${data.device_id}<br>${data.device_type}<br>${data.device_description}`;
            const yAxisParamsContainer = document.getElementById(containerId);
            yAxisParamsContainer.innerHTML = '';a_points, 'y-axis-params');
                    populateXAxisParams(data.data_points, 'x-axis-params');
            for (const key in dataPoints) {a.device_id, data.data_points);
                const paramCheckbox = document.createElement('div');
                paramCheckbox.className = 'flex items-center';
                paramCheckbox.innerHTML = `or('Error fetching device data:', error));
                    <input type="checkbox" id="${key}" name="yAxisParams" value="${key}" class="mr-2">
                    <label for="${key}" class="text-gray-700">${key}</label>
                `;device webhook URL
                yAxisParamsContainer.appendChild(paramCheckbox);
            }the current domain with protocol and port
        }rigin = window.location.origin;
    
        function populateXAxisParams(dataPoints, containerId) {
    const xAxisParamsContainer = document.getElementById(containerId);
    xAxisParamsContainer.innerHTML = '';re provided
        dataPoints = {
    for (const key in dataPoints) {
        const paramRadio = document.createElement('div');
        paramRadio.className = 'flex items-center';
        paramRadio.innerHTML = `
            <input type="radio" id="x-axis-${key}" name="xAxisParam" value="${key}" class="mr-2">
            <label for="x-axis-${key}" class="text-gray-700">${key}</label>
        `;struct the URL using the fetched origin
        xAxisParamsContainer.appendChild(paramRadio);
    }
    for (const [key, value] of Object.entries(dataPoints)) {
    const paramRadio = document.createElement('div');
        paramRadio.className = 'flex items-center';
        paramRadio.innerHTML = `
            <input type="radio" id="x-axis-timestamp" name="xAxisParam" value="time" class="mr-2">
            <label for="x-axis-timestamp" class="text-gray-700">timestamp</label>
        `;
        xAxisParamsContainer.appendChild(paramRadio);

    
}       // Update device data points
        function updateDeviceDataPoints(dataPoints) {
            const deviceDataPoints = document.getElementById('device-data-points');
        // Populate alert parametersML = '';
        function populateAlertParameters(dataPoints) {
            const alertParameterSelect = document.getElementById('alert-parameter');
            alertParameterSelect.innerHTML = '';reateElement('div');
                dataPointCard.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
            for (const key in dataPoints) {
                const option = document.createElement('option');>
                option.value = key;2xl">${value}</p>
                option.textContent = key;
                alertParameterSelect.appendChild(option);d);
            }
        }
    
        // Fetch and update alert listfor chart creation
        function fetchAlerts(deviceId) {aPoints, containerId) {
            fetch(`/get-alerts/${deviceId}`, {ent.getElementById(containerId);
                headers: {tainer.innerHTML = '';
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }const key in dataPoints) {
            })  const paramCheckbox = document.createElement('div');
                .then(response => response.json())ems-center';
                .then(data => {nnerHTML = `
                    if (data.alerts) {box" id="${key}" name="yAxisParams" value="${key}" class="mr-2">
                        updateAlertList(data.alerts);ray-700">${key}</label>
                    } else {
                        // showError('Error fetching alerts'););
                    }
                })
                .catch(error => console.error('Error fetching alerts:', error));
        }unction populateXAxisParams(dataPoints, containerId) {
    const xAxisParamsContainer = document.getElementById(containerId);
        // Update alert listerHTML = '';
        function updateAlertList(alerts) {
            const alertList = document.getElementById('alert-list');
            alertList.innerHTML = '';reateElement('div');
        paramRadio.className = 'flex items-center';
            alerts.forEach(alert => {
                const alertItem = document.createElement('li');aram" value="${key}" class="mr-2">
                alertItem.className = 'bg-gray-700 p-2 rounded flex justify-between items-center text-white';
                alertItem.innerHTML = `
                    <span>${alert.name} - ${alert.parameter}: ${alert.value}</span>
                    <button class="bg-red-500 text-white px-2 py-1 rounded delete-alert-btn" data-alert-id="${alert.id}">Delete</button>
                `;
                alertList.appendChild(alertItem);v');
        paramRadio.className = 'flex items-center';
                alertItem.querySelector('.delete-alert-btn').addEventListener('click', function() {
                    const alertId = this.getAttribute('data-alert-id'); value="time" class="mr-2">
                    deleteAlert(alertId); class="text-gray-700">timestamp</label>
                });
            });ramsContainer.appendChild(paramRadio);
        }
    
        // Create new alert
        function CreateAlert() {
            // event.preventDefault();
        // Populate alert parameters
            const deviceId = getDeviceIdFromUrl();s) {
            const alertName = document.getElementById('alert-name').value;rameter');
            const alertParameter = document.getElementById('alert-parameter').value;
            const alertValue = document.getElementById('alert-value').value;
            const alertGate = document.getElementById('alert-gate').value;
                const option = document.createElement('option');
            fetch('/create_alert', {
                method: 'POST',ent = key;
                headers: {eterSelect.appendChild(option);
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify({
                    device_id: deviceId,
                    alert_name: alertName,`, {
                    alert_parameter: alertParameter,
                    alert_value: alertValue, ' + localStorage.getItem('token')
                    alert_gate: alertGate
                })
            })  .then(response => response.json())
            .then(response => response.json())
            .then(data => {a.alerts) {
                fetchAlerts(deviceId);t(data.alerts);
            })      } else {
            .catch(error => console.error('Error creating alert:', error));
        }           }
                })
        // Delete alerterror => console.error('Error fetching alerts:', error));
        function deleteAlert(alertId) {
            fetch(`/delete_alert/${alertId}`, {
                method: 'POST',
                headers: {rtList(alerts) {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }List.innerHTML = '';
            })
            .then(response => response.json())
            .then(data => {Item = document.createElement('li');
                const deviceId = getDeviceIdFromUrl(); rounded flex justify-between items-center text-white';
                fetchAlerts(deviceId);`
            })      <span>${alert.name} - ${alert.parameter}: ${alert.value}</span>
            .catch(error => console.error('Error deleting alert:', error));delete-alert-btn" data-alert-id="${alert.id}">Delete</button>
        }       `;
                alertList.appendChild(alertItem);
        // Function to get device ID from URL
        function getDeviceIdFromUrl() {('.delete-alert-btn').addEventListener('click', function() {
            const urlParts = window.location.pathname.split('/');-id');
            return urlParts[urlParts.length - 1];
        }       });
            });
        }
    
        // Create new alert
        function CreateAlert() {
            // event.preventDefault();
    
            const deviceId = getDeviceIdFromUrl();
            const alertName = document.getElementById('alert-name').value;
            const alertParameter = document.getElementById('alert-parameter').value;
            const alertValue = document.getElementById('alert-value').value;
function fetchDeviceData(deviceId) {nt.getElementById('alert-gate').value;
    return fetch(`/device_data/${deviceId}`)
        .then(response => response.json())
        .then(data => { 'POST',
            document.getElementById('device-name').textContent = data.device_name;
            document.getElementById('device-details').innerHTML = `${data.device_id}<br>${data.device_type}<br>${data.device_description}`;
            updateDeviceDataPoints(data.data_points);lStorage.getItem('token')
            populateYAxisParams(data.data_points, 'y-axis-params');
            populateXAxisParams(data.data_points, 'x-axis-params');
            updateDeviceWebhook(data.device_id, data.data_points);
            populateAlertParameters(data.data_points);
        })          alert_parameter: alertParameter,
        .catch(error => console.error('Error fetching device data:', error));
}                   alert_gate: alertGate
                })
function fetchDeviceCharts(deviceId) {
    return fetch(`/get-charts/${deviceId}`)())
        .then(response => {
            if (!response.ok) {iceId);
                throw new Error('Network response was not ok');
            }catch(error => console.error('Error creating alert:', error));
            return response.json();
        })
        .then(data => {
            if (data.error) {alertId) {
                showError(data.error);rtId}`, {
            } else {od: 'POST',
                updateDeviceCharts(data.charts);
            }       'Authorization': 'Bearer ' + localStorage.getItem('token')
        })      }
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
            // showError('An error occurred while fetching charts.');
        });     const deviceId = getDeviceIdFromUrl();
}               fetchAlerts(deviceId);
            })
document.addEventListener('DOMContentLoaded', () => {ting alert:', error));
    const deviceId = getDeviceIdFromUrl();
    fetchDeviceData(deviceId)
        .then(() => {o get device ID from URL
            return fetchDeviceCharts(deviceId);
        })  const urlParts = window.location.pathname.split('/');
        .then(() => {lParts[urlParts.length - 1];
            fetchAlerts(deviceId);
            fetchNotifications(deviceId); // Add this line to fetch notifications on page load
            // updateChartsPeriodically();
            generateChartsForDevice(deviceId);
        })
        .catch(error => console.error(error));
});


function getDeviceIdFromUrl() {
    const urlParts = window.location.pathname.split('/');
    return urlParts[urlParts.length - 1];
}unction fetchDeviceData(deviceId) {
    return fetch(`/device_data/${deviceId}`)
function fetchNotifications(device_id) {))
            const token = localStorage.getItem('token'); // Retrieve the token from local storage
            // console.log('Fetching notifications for device_id:', device_id); // Log the device ID
            // console.log('Using token:', token); // Log the token being usedce_id}<br>${data.device_type}<br>${data.device_description}`;
            updateDeviceDataPoints(data.data_points);
            $.ajax({YAxisParams(data.data_points, 'y-axis-params');
                url: `/get-notifications/${device_id}`,is-params');
                type: 'GET',ook(data.device_id, data.data_points);
                headers: {arameters(data.data_points);
                    'Authorization': `Bearer ${token}`
                },or => console.error('Error fetching device data:', error));
                success: function(data, textStatus, jqXHR) {
                    // console.log('AJAX call succeeded');
                    // console.log('Status:', textStatus);
                    // console.log('Data:', data); // Log the raw response string
                    populateNotificationsList(data.notifications);
                    updateNotificationCounter(data.unseen_count);
                },row new Error('Network response was not ok');
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log('AJAX call failed');
                    console.error('Error:', textStatus, errorThrown);
                }a => {
            });(data.error) {
        }       showError(data.error);
            } else {
        function populateNotificationsList(notifications) {
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = ''; // Clear any existing notifications
        .catch(error => {
            notifications.forEach(notification => { the fetch operation:', error);
                const listItem = document.createElement('li');rts.');
                listItem.className = 'bg-gray-700 p-2 rounded text-white';
                listItem.innerHTML = `
                    <strong>${notification.alert_name}</strong><br>
                    ${notification.message}<br>) => {
                    <small>${notification.time}</small>
                `;a(deviceId)
                notificationsList.appendChild(listItem);
            });urn fetchDeviceCharts(deviceId);
        })
        .then(() => {
            fetchAlerts(deviceId);
function updateNotificationList(notifications) { this line to fetch notifications on page load
            // updateChartsPeriodically();
    const notificationList = document.getElementById('notifications-list');
    notificationList.innerHTML = '';
        .catch(error => console.error(error));
    notifications.forEach(notification => {
        const notificationItem = document.createElement('li');
        notificationItem.className = 'bg-gray-700 p-2 rounded';
        notificationItem.textContent = notification.notification_message;
        notificationList.appendChild(notificationItem););
    });urn urlParts[urlParts.length - 1];
}

function updateNotificationCounter(count) {
    const notificationCounter = document.getElementById('notification-counter');rom local storage
    if (count > 0) {le.log('Fetching notifications for device_id:', device_id); // Log the device ID
        notificationCounter.textContent = count;); // Log the token being used
        notificationCounter.classList.remove('hidden');
    } else {$.ajax({
        notificationCounter.classList.add('hidden');}`,
    }           type: 'GET',
}               headers: {
                    'Authorization': `Bearer ${token}`
document.getElementById('notifications-tab').addEventListener('click', function () {
    document.getElementById('notifications-tab').classList.add('active-tab');
    document.getElementById('notifications-tab').classList.remove('inactive-tab');
    document.getElementById('alerts-tab').classList.remove('active-tab');
    document.getElementById('alerts-tab').classList.add('inactive-tab');se string
    document.getElementById('data-feed-tab').classList.remove('active-tab');
    document.getElementById('data-feed-tab').classList.add('inactive-tab');
                },
    document.getElementById('alerts-content').classList.add('hidden');
    document.getElementById('notifications-content').classList.remove('hidden');
    document.getElementById('data-feed-content').classList.add('hidden');
                }
    // Mark notifications as seen
    const deviceId = getDeviceIdFromUrl();
    fetch(`/mark-notifications-seen/${deviceId}`, {
        method: 'POST',teNotificationsList(notifications) {
        headers: {notificationsList = document.getElementById('notifications-list');
            'Authorization': 'Bearer ' + localStorage.getItem('token')tifications
        }
    })      notifications.forEach(notification => {
    .then(response => response.json())ent.createElement('li');
    .then(data => {tItem.className = 'bg-gray-700 p-2 rounded text-white';
        if (data.error) {innerHTML = `
            showError(data.error);fication.alert_name}</strong><br>
        } else {    ${notification.message}<br>
            updateNotificationCounter(0);.time}</small>
        }       `;
    })          notificationsList.appendChild(listItem);
    .catch(error => console.error('Error marking notifications as seen:', error));
});     }

setInterval(() => {
    const deviceId = getDeviceIdFromUrl();ons) {
    fetchDeviceData(deviceId);
    fetchDeviceCharts(deviceId);ument.getElementById('notifications-list');
    fetchNotifications(deviceId);'';
    generateChartsForDevice(deviceId);
}, 5 * 60 * 1000);forEach(notification => {
        const notificationItem = document.createElement('li');
        notificationItem.className = 'bg-gray-700 p-2 rounded';
function generateChartsForDevice(deviceId) {ication.notification_message;
    fetch(`/device_data_last_20/${deviceId}`, {onItem);
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
    })on updateNotificationCounter(count) {
    .then(response => {ounter = document.getElementById('notification-counter');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }otificationCounter.classList.remove('hidden');
        return response.json();
    })  notificationCounter.classList.add('hidden');
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {entById('notifications-tab').addEventListener('click', function () {
            if (data.length === 0) {ations-tab').classList.add('active-tab');
                console.log('No data available for the selected device.');e-tab');
                return;ById('alerts-tab').classList.remove('active-tab');
            }getElementById('alerts-tab').classList.add('inactive-tab');
    document.getElementById('data-feed-tab').classList.remove('active-tab');
            const xAxisParam = 'time'; // Assuming time is always the X-axis parameter
            const yAxisParams = Object.keys(data[0].data); // Dynamically get Y-axis parameters from the first data point
            const xAxisValues = data.map(point => point[xAxisParam]);;
    document.getElementById('notifications-content').classList.remove('hidden');
            // Clear previous charts if anyent').classList.add('hidden');
            document.getElementById('chart_response').innerHTML = '';
    // Mark notifications as seen
            // Create a wrapper div for all charts
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';
            document.getElementById('chart_response').appendChild(gridContainer);
            'Authorization': 'Bearer ' + localStorage.getItem('token')
            // Create a chart for each Y-axis parameter
            yAxisParams.forEach(param => {
                const paramData = data.map(point => point.data[param]);
    .then(data => {
                // Create a container for each chart
                const chartContainer = document.createElement('div');
                chartContainer.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
                chartContainer.innerHTML = `
                    <h3 class="text-lg font-semibold">${titleCase(param)}</h3>
                    <canvas id="chart_${param}"></canvas>
                `;> console.error('Error marking notifications as seen:', error));
                gridContainer.appendChild(chartContainer);

                const ctx = document.getElementById(`chart_${param}`).getContext('2d');
    const deviceId = getDeviceIdFromUrl();
                new Chart(ctx, {
                    type: 'line', // or 'bar', 'pie', etc.
                    data: {ceId);
                        labels: xAxisValues,
                        datasets: [{
                            label: titleCase(param),
                            data: paramData,
                            backgroundColor: getRandomColor(),
                            borderColor: getRandomColor(),
                            borderWidth: 1
                        }]': 'Bearer ' + localStorage.getItem('token')
                    },
                    options: {
                        scales: {
                            x: {
                                title: {ponse was not ok');
                                    display: true,
                                    text: titleCase(xAxisParam)
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }th === 0) {
                    }le.log('No data available for the selected device.');
                });urn;
            });
        
            const chartResponseDiv = document.getElementById('chart_response');rameter
            const yAxisParams = Object.keys(data[0].data); // Dynamically get Y-axis parameters from the first data point
            // Check if the element existsoint => point[xAxisParam]);
            if (chartResponseDiv) {
                // Move all child nodes out of the chart_response div
                while (chartResponseDiv.firstChild) {.innerHTML = '';
                    chartResponseDiv.parentNode.insertBefore(chartResponseDiv.firstChild, chartResponseDiv);
                }eate a wrapper div for all charts
            const gridContainer = document.createElement('div');
                // Remove the chart_response div-cols-1 md:grid-cols-3 gap-4';
                chartResponseDiv.remove();_response').appendChild(gridContainer);
            }
        }   // Create a chart for each Y-axis parameter
    })      yAxisParams.forEach(param => {
    .catch(error => { paramData = data.map(point => point.data[param]);
        console.error('There was a problem with the fetch operation:', error);
        // showError('An error occurred while fetching device data.');
    });         const chartContainer = document.createElement('div');
}               chartContainer.className = 'bg-gradient-to-r from-teal-500 to-cyan-600 p-4 rounded-lg shadow-lg text-white card-border';
                chartContainer.innerHTML = `
// Call the function with a valid deviceIdt-semibold">${titleCase(param)}</h3>
document.addEventListener('DOMContentLoaded', () => {vas>
    const deviceId = getDeviceIdFromUrl();
    generateChartsForDevice(deviceId);ild(chartContainer);
});
                const ctx = document.getElementById(`chart_${param}`).getContext('2d');

    </script>   new Chart(ctx, {
                    type: 'line', // or 'bar', 'pie', etc.
    <script>        data: {
                        labels: xAxisValues,
        function startMultiStepTour(steps) {
            document.addEventListener('DOMContentLoaded', function() {
                // Define the tour stepsata,
                var tourSteps = steps.map(step => {domColor(),
                    return {borderColor: getRandomColor(),
                        target: step.targetId,
                        title: step.title,
                        content: step.content,
                        placement: step.placement || 'bottom', // Default to 'bottom' if no placement is provided
                    };  scales: {
                });         x: {
                                title: {
                var tour = {        display: true,
                    id: "multi-step-tour",titleCase(xAxisParam)
                    steps: tourSteps,
                    showPrevButton: true,
                    scrollTopMargin: 100
                };              beginAtZero: true
                            }
                // Start the tour
                hopscotch.startTour(tour);
                });
                // Scroll to the first target element to bring it into view
                if (steps.length > 0) {
                    document.getElementById(steps[0].targetId).scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });Check if the element exists
        }   if (chartResponseDiv) {
                // Move all child nodes out of the chart_response div
        //Mimic Demo Device Data Calliv.firstChild) {
        document.getElementById('send-demo-data-btn').addEventListener('click', function() {artResponseDiv);
    // Get the URL from the device-webhook-url element
    const url = document.getElementById('device-webhook-url').textContent;
                // Remove the chart_response div
    // Send a GET request to the URLove();
    fetch(url)
        .then(response => {
            if (response.ok) {
                alert('Demo device data sent successfully!');
                window.location.reload();m with the fetch operation:', error);
            } else {('An error occurred while fetching device data.');
                alert('Failed to send demo device data.');
            }
        })
        .catch(error => { a valid deviceId
            alert('Error: ' + error.message); () => {
        });eviceId = getDeviceIdFromUrl();
}); generateChartsForDevice(deviceId);
});

startMultiStepTour([
            {
                targetId: 'device-name',
                title: 'Device Information',
                content: 'This section defines the Device Name, followed by Device ID, Device Type & Device Description.',
                placement: 'right'r(steps) {
            },cument.addEventListener('DOMContentLoaded', function() {
            {   // Define the tour steps
                targetId: 'device-webhook-url',=> {
                title: 'Point Device To This URL',
                content: 'To start receiving data for this device, make your IoT Device to call this URL format, changing the parameters and their respective values.',
                placement: 'left'ep.title,
            },          content: step.content,
            {           placement: step.placement || 'bottom', // Default to 'bottom' if no placement is provided
                targetId: 'send-demo-data-btn',
                title: 'Initiate Demo Device Ping.',
                content: 'This demo ping mimics a call from your IoT Device to our platform.',
                placement: 'left'
            },      id: "multi-step-tour",
            {       steps: tourSteps,
                targetId: 'alerts-content',
                title: 'Set Notification Alerts',
                content: 'Here you can set notification alerts from your device. This section doesnt work unless you capture device data or ping demo device data.',
                placement: 'left'
            },  // Start the tour
            {   hopscotch.startTour(tour);
                targetId: 'alert-list',
                title: 'Alert List',st target element to bring it into view
                content: 'This will show all the alerts set for this device.',
                placement: 'bottom'mentById(steps[0].targetId).scrollIntoView({ behavior: 'smooth', block: 'center' });
            },  }
            {);
                targetId: 'notifications-tab',
                title: 'Notifications List',
                content: 'Click here to view all the latest notification alerts from your device. This section doesnt work unless you capture any device alerts.',
                placement: 'left'send-demo-data-btn').addEventListener('click', function() {
            }, URL from the device-webhook-url element
            { = document.getElementById('device-webhook-url').textContent;
                targetId: 'device-data-points',
                title: 'Device Data Points',
                content: 'This section will display the last fetched device data parameters and their respective values. This section doesnt work unless you capture any device data or ping demo device data.',
                placement: 'top'
            }, (response.ok) {
            {   alert('Demo device data sent successfully!');
                targetId: 'chart_device_feed_section',
                title: 'Device Data Point Charts',
                content: 'This section will display individual data chart for each parameter from the device data and maps the last 20 records for each parameter.',
                placement: 'top'
            },
            {h(error => {
                targetId: 'add-data-btn',ge);
                title: 'Create A New Device Data Chart',
                content: 'Click here to add a new device data chart. You can choose custom parameters on both X & Y Axis. This section will not render proper chart unless you capture any device data or ping demo device data.',
                placement: 'left'
            }
            epTour([
        ]); {
                targetId: 'device-name',
                title: 'Device Information',
document.getElementById('add-device-btn').eddEventListener('click', function(){ice ID, Device Type & Device Description.',
    startMultiStepTour([t: 'right'
            {,
                targetId: 'device-id',
                title: 'Numerical Unique Device ID',
                content: 'Add your unique numerical device id.',
                placement: 'right' receiving data for this device, make your IoT Device to call this URL format, changing the parameters and their respective values.',
            },  placement: 'left'
            {,
                targetId: 'device-name',
                title: 'Point Device To This URL',
                content: 'To start receiving data for this device, make your IoT Device to call this URL format, changing the parameters and their respective values.',
                placement: 'left'mo ping mimics a call from your IoT Device to our platform.',
            }   placement: 'left'
            },
        ]); {
                targetId: 'alerts-content',
 });            title: 'Set Notification Alerts',
        </script>ontent: 'Here you can set notification alerts from your device. This section doesnt work unless you capture device data or ping demo device data.',
                placement: 'left'
</body>     },
            {
</html>         targetId: 'alert-list',
<script>                title: 'Alert List',










































































</script>    }        });            allDeviceDataList.appendChild(row);            `;                <td class="border px-4 py-2">${JSON.stringify(record.data)}</td>                <td class="border px-4 py-2">${new Date(record.timestamp).toLocaleString()}</td>            row.innerHTML = `            const row = document.createElement('tr');        records.forEach(record => {        allDeviceDataList.innerHTML = '';        const allDeviceDataList = document.getElementById('all-device-data-list');    function updateAllDeviceDataList(records) {    // Update the All Device Data list    }            .catch(error => console.error('Error fetching all device data:', error));            })                }                    updateAllDeviceDataList(data.records);                } else {                    showError(data.error);                if (data.error) {            .then(data => {            .then(response => response.json())        fetch(`/get-all-device-data/${deviceId}`)    function fetchAllDeviceData(deviceId) {    // Fetch all device data    });        fetchAllDeviceData(deviceId);        const deviceId = getDeviceIdFromUrl();        // Fetch all device data        document.getElementById('all-device-data-content').classList.remove('hidden');        document.getElementById('notifications-content').classList.add('hidden');        document.getElementById('alerts-content').classList.add('hidden');        document.getElementById('notifications-tab').classList.add('inactive-tab');        document.getElementById('notifications-tab').classList.remove('active-tab');        document.getElementById('alerts-tab').classList.add('inactive-tab');        document.getElementById('alerts-tab').classList.remove('active-tab');        document.getElementById('all-device-data-tab').classList.remove('inactive-tab');        document.getElementById('all-device-data-tab').classList.add('active-tab');    document.getElementById('all-device-data-tab').addEventListener('click', function () {    });        document.getElementById('all-device-data-content').classList.add('hidden');        document.getElementById('notifications-content').classList.remove('hidden');        document.getElementById('alerts-content').classList.add('hidden');        document.getElementById('all-device-data-tab').classList.add('inactive-tab');        document.getElementById('all-device-data-tab').classList.remove('active-tab');        document.getElementById('alerts-tab').classList.add('inactive-tab');        document.getElementById('alerts-tab').classList.remove('active-tab');        document.getElementById('notifications-tab').classList.remove('inactive-tab');        document.getElementById('notifications-tab').classList.add('active-tab');    document.getElementById('notifications-tab').addEventListener('click', function () {    });        document.getElementById('all-device-data-content').classList.add('hidden');        document.getElementById('notifications-content').classList.add('hidden');        document.getElementById('alerts-content').classList.remove('hidden');        document.getElementById('all-device-data-tab').classList.add('inactive-tab');        document.getElementById('all-device-data-tab').classList.remove('active-tab');        document.getElementById('notifications-tab').classList.add('inactive-tab');        document.getElementById('notifications-tab').classList.remove('active-tab');        document.getElementById('alerts-tab').classList.remove('inactive-tab');        document.getElementById('alerts-tab').classList.add('active-tab');    document.getElementById('alerts-tab').addEventListener('click', function () {    // Tab switching logic                content: 'This will show all the alerts set for this device.',
                placement: 'bottom'
            },
            {
                targetId: 'notifications-tab',
                title: 'Notifications List',
                content: 'Click here to view all the latest notification alerts from your device. This section doesnt work unless you capture any device alerts.',
                placement: 'left'
            },
            {
                targetId: 'device-data-points',
                title: 'Device Data Points',
                content: 'This section will display the last fetched device data parameters and their respective values. This section doesnt work unless you capture any device data or ping demo device data.',
                placement: 'top'
            },
            {
                targetId: 'chart_device_feed_section',
                title: 'Device Data Point Charts',
                content: 'This section will display individual data chart for each parameter from the device data and maps the last 20 records for each parameter.',
                placement: 'top'
            },
            {
                targetId: 'add-data-btn',
                title: 'Create A New Device Data Chart',
                content: 'Click here to add a new device data chart. You can choose custom parameters on both X & Y Axis. This section will not render proper chart unless you capture any device data or ping demo device data.',
                placement: 'left'
            }
            
        ]);


document.getElementById('add-device-btn').eddEventListener('click', function(){
    startMultiStepTour([
            {
                targetId: 'device-id',
                title: 'Numerical Unique Device ID',
                content: 'Add your unique numerical device id.',
                placement: 'right'
            },
            {
                targetId: 'device-name',
                title: 'Point Device To This URL',
                content: 'To start receiving data for this device, make your IoT Device to call this URL format, changing the parameters and their respective values.',
                placement: 'left'
            }
            
        ]);

 });       
        </script>
             
</body>

</html>
